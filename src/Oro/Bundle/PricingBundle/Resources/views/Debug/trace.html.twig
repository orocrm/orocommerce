{% extends '@OroUI/actions/index.html.twig' %}
{% import '@OroUI/macros.html.twig' as UI %}
{% oro_title_set({params : {"%sku%": product.sku|default('N/A'|trans), "%name%": product.defaultName.string|default('N/A'|trans) }}) %}

{% block content_datagrid %}
    {% set content_attr = content_attr|default({})|merge({
        'class': (content_attr.class is defined ? content_attr.class : 'layout-content')|trim
    }) %}

    <div{{ UI.attributes(content_attr) }}
            {% if pageComponent is defined %}{{ UI.renderPageComponentAttributes(pageComponent) }}{% endif %}
    >
        <div class="container-fluid page-title">
            {% set pageActionsBlock %}
                {% block pageActions %}
                    {% placeholder view_pageActions_before with {entity: product} %}
                    {% placeholder view_pageActions_after with {entity: product} %}
                {% endblock pageActions %}
            {% endset %}

            <div class="navigation navbar-extra navbar-extra-right">
                {% block pageHeader %}
                    <div class="row">
                        <div class="pull-left-extra">

                            <div class="page-title__path">
                                <div class="top-row">
                                    {% set breadcrumbs = {
                                        'entity': product,
                                        'indexPath': path('oro_pricing_price_product_debug_index'),
                                        'indexLabel': 'oro.pricing.productprice.debug.page_title'|trans,
                                        'entityTitle': product.sku ~ ' - ' ~ product.defaultName
                                    } %}

                                    {{ block("breadcrumbs", "@OroUI/actions/view.html.twig") }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row inline-info">
                        <div class="pull-right page-title__entity-info-state">
                            <div class="inline-decorate-container">
                                <ul class="inline-decorate">
                                    {{ pageActionsBlock }}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endblock pageHeader %}
            </div>
            {% placeholder page_title_after with {entity: product} %}
        </div>

        {% set content_data_attr = content_data_attr|default({})|merge({
            'class': ((content_data_attr.class is defined ? content_data_attr.class : 'layout-content') ~ ' scrollable-container')|trim
        }) %}

        <div class="layout-content product-container" data-role="grid-sidebar-component-container">
            <div class="scrollable-container sidebar-container">
                {% embed "@OroUI/content_sidebar.html.twig" %}
                    {% block sidebar %}
                        {% set componentOptions = {
                            sidebarAlias: 'product-prices-debug-view-sidebar',
                            widgetAlias: 'trace-sidebar-data-widget'
                        } %}

                        <div data-page-component-module="orodatagrid/js/app/components/grid-sidebar-component"
                             data-page-component-options="{{ componentOptions|json_encode }}"
                        >
                            {{ render(controller('Oro\\Bundle\\PricingBundle\\Debug\\Controller\\DebugController::sidebarViewAction', {product: product})) }}
                        </div>
                    {% endblock sidebar %}

                    {% block content %}
                        {% import '@OroUI/macros.html.twig' as UI %}
                        <div class="category-data">
                            <div{{ UI.attributes(content_data_attr) }}>
                                {% block content_data %}
                                    {% import '@OroUI/macros.html.twig' as UI %}

                                    {% set pricesTable %}
                                        {% if current_prices is empty %}
                                            {{ 'oro.pricing.productprice.debug.no_prices.label'|trans }}
                                        {% else %}
                                        {% for currency, prices in current_prices %}
                                            {% with {value: prices, shownUnit: '', showTierPrices: true} %}
                                            {{ block("prices_table", "@OroPricing/Datagrid/Column/productPrice.html.twig") }}
                                            {% endwith %}
                                        {% endfor %}
                                        {% endif %}
                                    {% endset %}
                                    {% set pricing_strategy_name = ('oro.pricing.system_configuration.fields.strategy_type.choices.' ~ oro_config_value('oro_pricing.price_strategy'))|trans %}

                                    {% set generalSection %}
                                        {{ UI.renderHtmlProperty(
                                            'oro.product.entity_label'|trans,
                                            UI.entityViewLink(product, product.defaultName.string, 'oro_product_view')
                                        ) }}

                                        {{ UI.renderProperty(
                                            'oro.pricing.productprice.debug.combined_price_list.label'|trans,
                                            cplId
                                        ) }}

                                        {% if fullChainCplId %}
                                            {{ UI.renderProperty(
                                                'oro.pricing.productprice.debug.full_combined_price_list.label'|trans,
                                                fullChainCplId
                                            ) }}
                                        {% endif %}

                                        {{ UI.renderHtmlProperty(
                                            'oro.pricing.productprice.debug.pricing_strategy.label'|trans,
                                            UI.link({
                                                'label' : pricing_strategy_name,
                                                'title' : pricing_strategy_name,
                                                'path'  : path('oro_config_configuration_system', {'activeGroup': 'commerce', 'activeSubGroup': 'pricing'})
                                            })
                                        ) }}
                                        {{ UI.renderHtmlProperty('oro.pricing.productprice.debug.current_prices.label'|trans, pricesTable) }}
                                    {% endset %}

                                    {% set chainSection %}
                                        {% include '@OroPricing/Customer/price_list_view.html.twig' with {
                                            'fallback': null,
                                            'priceLists': cpl_used_price_lists
                                        } %}
                                    {% endset %}

                                    {% if full_cpl_used_price_lists is not null  %}
                                        {% set fullChainSection %}
                                            {% include '@OroPricing/Customer/price_list_view.html.twig' with {
                                                'fallback': null,
                                                'priceLists': full_cpl_used_price_lists
                                            } %}
                                        {% endset %}
                                    {% endif %}

                                    {% set priceMergeDetailsSection %}
                                        {% set tabsOptions = {
                                            verticalTabs: true,
                                            useDropdown: false
                                        } %}

                                        {# TODO: Extract #}
                                        <style>
                                            .price-list-prices .selected-price {
                                                font-weight: bold;
                                            }
                                            .price-list-prices .price-unit {
                                                list-style: none;
                                                font-weight: bold;
                                                margin-top: 10px;
                                            }
                                            .price-list-prices .new-currency {
                                                margin-top: 10px;
                                            }
                                        </style>

                                        {% for used_price_list_relation in cpl_used_price_lists %}
                                            {% set price_list = used_price_list_relation.priceList %}
                                            {% set tabContent %}
                                                {% if price_merging_details[price_list.id] is defined  %}
                                                    <table class="price-list-prices">
                                                        {% set shownUnit = '' %}
                                                        {% set showCurrency = '' %}
                                                        {% for price_data in price_merging_details[price_list.id] %}
                                                            {% set price = price_data.price %}
                                                            {% if shownUnit != price.productUnitCode %}
                                                                {% set shownUnit = price.productUnitCode %}
                                                                <tr>
                                                                    <td colspan="2" class="renderable">
                                                                        <div class="product-price-unit-with-margin">
                                                                            <strong>{{ shownUnit|oro_format_product_unit_label|capitalize }}</strong>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            {% endif %}

                                                            <tr class="{% if price_data.is_selected %}selected-price{% else %}not-selected-price{% endif %}
                                                            {% if showCurrency != price.price.currency %}{% set showCurrency = price.price.currency %}new-currency{% endif %}">
                                                                <td class="renderable">
                                                                    <div class="text-right">{{ price.quantity }}:&nbsp;</div>
                                                                </td>

                                                                <td class="renderable">
                                                                    <div class="text-left">{{ price.price|oro_format_price }}</div>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                {% else %}
                                                    {{ 'oro.pricing.productprice.debug.no_prices.message'|trans }}
                                                    <p></p>
                                                {% endif %}
                                            {% endset %}

                                            {% set tabs = [{
                                                'alias': 'oro_prices_info_' ~ loop.index,
                                                'widgetType': 'oro_prices_info',
                                                'label': price_list.name,
                                                'content': tabContent,
                                                'url': null
                                            }] %}

                                            {{ tabPanel(tabs, tabsOptions|default({})) }}
                                        {% endfor %}
                                    {% endset %}

                                    {% set dataBlocks = [
                                        {
                                            'title': 'oro.pricing.productprice.debug.general.label'|trans,
                                            'subblocks':  [{'data' : [generalSection]}]
                                        },
                                        {
                                            'title': 'oro.pricing.productprice.debug.price_list_used_chain.label'|trans,
                                            'subblocks':  [{'data' : [chainSection]}]
                                        }
                                    ] %}

                                    {% if fullChainSection is defined %}
                                        {% set dataBlocks = dataBlocks|merge([{
                                            'title': 'oro.pricing.productprice.debug.full_price_list_used_chain.label'|trans,
                                            'subblocks':  [{'data' : [fullChainSection]}]
                                        }]) %}
                                    {% endif %}

                                    {% set dataBlocks = dataBlocks|merge([{
                                        'title': 'oro.pricing.productprice.debug.price_merge_details.label'|trans,
                                        'subblocks':  [{'data' : [priceMergeDetailsSection]}]
                                    }]) %}


                                    {% if cpl_activation_rules is not empty %}
                                        {% set activationRulesSection %}
                                            <table class="grid grid-main-container table-hover table table-bordered">
                                                <thead>
                                                <tr>
                                                    <th scope="col">{{ 'oro.pricing.productprice.debug.full_combined_price_list.label'|trans }}</th>
                                                    <th scope="col">{{ 'oro.pricing.productprice.debug.combined_price_list.label'|trans }}</th>
                                                    <th scope="col">{{ 'oro.cron.schedule_interval.active_at.label'|trans }}</th>
                                                    <th scope="col">{{ 'oro.cron.schedule_interval.deactivate_at.label'|trans }}</th>
                                                    <th scope="col">{{ 'oro.cron.schedule_interval.active_now'|trans }}</th>
                                                </tr>
                                                </thead>
                                            {% for cpl_activation_rule in cpl_activation_rules %}
                                                <tr>
                                                    <td>{{ cpl_activation_rule.fullChainPriceList.id }}</td>
                                                    <td>{{ cpl_activation_rule.combinedPriceList.id }}</td>
                                                    <td>{{ cpl_activation_rule.activateAt|oro_format_datetime }}</td>
                                                    <td>{{ cpl_activation_rule.expireAt|oro_format_datetime }}</td>
                                                    <td>{{ cpl_activation_rule.active ? 'Yes'|trans : 'No'|trans }}</td>
                                                </tr>
                                            {% endfor %}
                                            </table>
                                        {% endset %}

                                        {% set dataBlocks = dataBlocks|merge([{
                                            'title': 'Combined Price List Activation Rules',
                                            'subblocks':  [{'data' : [activationRulesSection]}]
                                        }]) %}
                                    {% endif %}

                                    {% if price_list_assignments is defined %}
                                        {% set assignmentsSection %}
                                            {% set tabsOptions = {
                                                verticalTabs: true,
                                                useDropdown: false
                                            } %}

                                            {% for assignments in price_list_assignments %}
                                                {% set tabContent %}
                                                    <a href="{{ assignments.link }}">{{ assignments.link_title }}</a>

                                                    {% include '@OroPricing/Customer/price_list_view.html.twig' with {
                                                        'fallback': assignments.fallback,
                                                        'priceLists': assignments.priceLists
                                                    } %}
                                                    <br/>
                                                {% endset %}

                                                {% set tabs = [{
                                                    'alias': 'oro_pricelist_assignment_info_' ~ loop.index,
                                                    'widgetType': 'oro_pricelist_assignment_info',
                                                    'label': assignments.section_title,
                                                    'content': tabContent,
                                                    'url': null
                                                }] %}

                                                {{ tabPanel(tabs, tabsOptions|default({})) }}
                                            {% endfor %}
                                        {% endset %}
                                        {% set dataBlocks = dataBlocks|merge([{
                                            'title': 'oro.pricing.productprice.debug.price_list_assignment_info.label'|trans,
                                            'subblocks':  [{'data' : [assignmentsSection]}]
                                        }]) %}
                                    {% endif %}

                                    {% set data = oro_view_process({'dataBlocks': dataBlocks}, product) %}
                                    {% set data = data|merge({'dataBlocks':  data.dataBlocks}) %}

                                    {{ UI.scrollData('product-price-debug-view', data, product) }}
                                {% endblock content_data %}
                            </div>
                        </div>
                    {% endblock content %}
                {% endembed %}
            </div>
        </div>
    </div>
{% endblock content_datagrid %}
