<%
function highlightWords(inputString, value) {
    if (!!inputString && _.isString(inputString)) {
        const highlightPattern = '<u class="search-autocomplete__highlight">$&</u>',
            inputWords = _.escape(inputString.trim()).split(' '),
            reg = new RegExp(inputWords.join('|'), 'gi'),
            fullText = decodeHTMLEntities(value.replace(reg, highlightPattern)),
            <!-- Split text to highlight or not highlight-->
            partsFullTextReg = /(<u[^>]*\bclass=["']search-autocomplete__highlight["'][^>]*>.*?<\/u>)/gi;

        return fullText.split(partsFullTextReg);
    } else {
        return value.split();
    }
}
%>
<%
    <!-- Align syntax, symbol and html entity to symbol (& and &amp; to &)-->
    function decodeHTMLEntities(text) {
        var textArea = document.createElement('textarea');
        textArea.innerHTML = text;

        return textArea.value;
    }
%>
<%
    function getValueFromTag(text) {
        const parser = new DOMParser(),
            element = parser.parseFromString(text, 'text/html'),
            ulElement = element.querySelector('u');

        return ulElement.textContent.trim();
    }
%>

<div class="search-autocomplete">
    <div class="search-autocomplete__content dropdown-menu">
        <% if (total_count > 0) { %>
            <ul class="search-autocomplete__list" id="<%- comboboxId %>" role="listbox">
                <%_.each(products, function(product) { %>
                <li class="search-autocomplete__item" role="option">
                    <a href="<%- product.url %>" class="search-autocomplete-product" title="<%- product.name %>">
                        <div class="search-autocomplete-product__image">
                            <picture>
                                <% if (product.imageWebp && product.imageWebp !== product.image) { %>
                                <source srcset="<%- product.imageWebp %>" type="image/webp">
                                <% } %>
                                <img src="<%- product.image %>" alt="<%- product.name %>">
                            </picture>
                        </div>
                        <div class="search-autocomplete-product__info">
                            <div class="search-autocomplete-product__head">
                                <div class="search-autocomplete-product__title">
                                    <!-- Use such code style cause in other way it's create a lot of white space in p tag -->
                                    <% _.each(highlightWords(inputString, product.name), function (part) { %><% if (part.startsWith('<u class="search-autocomplete__highlight">')) { %><u class="search-autocomplete__highlight"><%- getValueFromTag(part) %></u><%} else {%><%- part %><%}%><% }); %></div>
                                <% if (product.formatted_price) { %>
                                    <div class="search-autocomplete-product__price"><%- product.formatted_price %></div>
                                <% } %>
                            </div>
                            <div class="search-autocomplete-product__body">
                                <div class="search-autocomplete-product__sku">
                                    <% _.each(highlightWords(inputString, product.sku), function (part) { %><% if (part.startsWith('<u class="search-autocomplete__highlight">')) { %><u class="search-autocomplete__highlight"><%- getValueFromTag(part) %></u><%} else {%><%- part %><%}%><% }); %>
                                </div>
                                <div class="search-autocomplete-product__status <%- product.inventory_status %>"><%- decodeHTMLEntities(product.inventory_status_label) %></div>
                            </div>
                        </div>
                    </a>
                </li>
                <% }) %>
                <li class="search-autocomplete__item" role="option">
                    <button class="btn btn--link btn--no-offset search-autocomplete__submit"
                            type="submit"
                    ><%- _.__('oro.product.autocomplete.popup.button.all.label', { productCount: total_count }, total_count)  %> <span class="fa-angle-right" aria-hidden="true"></span>
                    </button>
                </li>
            </ul>
        <% } else { %>
            <div class="search-autocomplete__no-found"><%- _.__('oro.product.autocomplete.no_found') %></div>
        <% } %>
    </div>
</div>
